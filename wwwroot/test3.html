<!doctype html>
<html class="no-js">

<head>
    <meta charset="utf-8">
    <title>The Book of OpenLayers3 - Code samples</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="icon" href="favicon.ico" type="image/x-icon">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.4/jquery-ui.js"></link>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.4/jquery-ui.js" type="text/javascript"></script>

    <!-- OpenLayers -->
    <link rel="stylesheet" href="http://openlayers.org/en/v3.14.0/css/ol.css" type="text/css">
    <style>
        .divContainer,
        .divResize {
            border: dashed 1px #CCC;
            width: 120px;
            height: 120px;
            padding: 5px;
            margin: 5px;
            font: 13px Arial;
            cursor: move;
            float: left
        }
    </style>
</head>

<body>
    <div class="container">
        <div id="map" class="map"></div>
    </div>

    <script src="http://openlayers.org/en/v3.14.0/build/ol-debug.js" type="text/javascript"></script>

    <script id="code">
        function createImageOverlay(position, text) {
            var elem = $('<div draggable="true" style="cursor: move; position: relative; border:3px dashed;"><textarea style="min-width: 50; min-height: 50;">gfdfgdgf dfgdfgd nhjhj</textarea></div>');
            var overlay =  new ol.Overlay({
                //stopEvent: false,
                element: elem[0],
                position: position,
                positioning: 'top-left'
            });
            return overlay;
        }
            
        var layer = new ol.layer.Tile({
            source: new ol.source.MapQuest({
                layer: 'osm'
            })
        });
        var map = new ol.Map({
            target: 'map',
            renderer: 'canvas',
            layers: [layer],
            view: new ol.View({
                center: [0, 0],
                zoom: 2
            })
        });

        var clickOffset;
        
        document.addEventListener("drag", function( event ) {
            console.log("drag");
        }, false);

        document.addEventListener("dragstart", function( event ) {
            //event.target.style.opacity = .5;
            console.log("dragstart");
            clickOffset = [event.pageX - event.target.offsetParent.offsetLeft, event.pageY - event.target.offsetParent.offsetTop];
            //console.log(event.pageX, event.pageY, event.target.offsetParent.offsetLeft, event.target.offsetParent.offsetTop, event.pageX - event.target.offsetParent.offsetLeft, event.pageY - event.target.offsetParent.offsetTop );
        }, false);

        document.addEventListener("dragend", function( event ) {
            //event.target.style.opacity = "";
            console.log("dragend");
            var overlay = getOverlayForElement(event.target);
            if(overlay) {
                var newPosition = [event.pageX - clickOffset[0], event.pageY - clickOffset[1]];
                console.log([event.pageX, event.pageY], clickOffset, newPosition);
                var position = map.getCoordinateFromPixel(newPosition);
                overlay.setPosition(position);                    
            }
        }, false);

       function getOverlayForElement(element) {
            var overlay; 
            map.getOverlays().forEach(function(o) { 
                if(o.getElement() == element) {
                    overlay = o;
                }
            });
            return overlay;
        }

        $.get('./2012_Earthquakes_Mag5.kml')
            .done(function(response){
                var format = new ol.format.KML();
                var features = format.readFeatures(response, {
                    featureProjection: 'EPSG:3857'
                });
                var coordinates, overlay;
                for (var i = 0; i < features.length; i+=200) {
                    var text = features[i].get("name");
                    coordinates = features[i].getGeometry().getCoordinates();
                    overlay = createImageOverlay(coordinates, text);
                    map.addOverlay(overlay);
                    $(overlay.element).resizable().draggable();
                };
            });
    </script>

</body>

</html>