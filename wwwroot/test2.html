<!doctype html>
<html class="no-js">

<head>
    <meta charset="utf-8">
    <title>The Book of OpenLayers3 - Code samples</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="icon" href="favicon.ico" type="image/x-icon">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.4/jquery-ui.js"></link>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.4/jquery-ui.js" type="text/javascript"></script>

    <!-- OpenLayers -->
    <link rel="stylesheet" href="http://openlayers.org/en/v3.14.0/css/ol.css" type="text/css">
    <style>
        .divContainer,
        .divResize {
            border: dashed 1px #CCC;
            width: 120px;
            height: 120px;
            padding: 5px;
            margin: 5px;
            font: 13px Arial;
            cursor: move;
            float: left
        }
    </style>
</head>

<body>
    <div class="container">
        <div id="map" class="map"></div>
    </div>

    <script src="http://openlayers.org/en/v3.14.0/build/ol-debug.js" type="text/javascript"></script>

    <script id="code">
        function createImageOverlay(position, text) {
            //var elem = document.createElement('img');
            //elem.setAttribute('src', '//map.geo.admin.ch/1403704943/img/marker.png');

            //var elem = document.createElement("textarea");

            // var elem = document.createElement("input");
            // elem.setAttribute('type', 'text');
            // elem.setAttribute('value', text);
            //elem.setAttribute('class', "ui-widget-content");

            var elem = $('<div draggable="true" style="cursor: move;position: relative; xxxresize: both;border:1px dashed; width: 120; height: 120;"><h3 class="ui-widget-header">Resizable</h3><textarea>gfdfgdgf dfgdfgd nhjhj</textarea></div>');

            //var elem = $('<div style="border:1px dashed; position: absolute; width: 120; height: 120;"></div>');

            var clickOffset = null;

            elem.mousedown(function( event ) {
                //console.log("mousedown ------------------------");
                // xxxDown = true;
                // originalPosition = [event.pageX, event.pageY];
                // console.log(originalPosition);
                // console.log(elem.offset());
                // var elementPosition = elem.offset();
                // clickOffset = [event.pageX - elementPosition.left, event.pageY - elementPosition.top];
                // console.log(clickOffset);
                //   overlay.setPosition(position);
                //   return;
                //   //mapPntPx = mapPntPx.add((event.pageX*-1), (event.pageX*-1));
                //   //this.popup.lonlat = map.getLonLatFromViewPortPx(mapPntPx);
                //  var mouseCoordInMapPixels = [event.originalEvent.offsetX, event.originalEvent.offsetY];
                //     console.log(mouseCoordInMapPixels);
                //      //var lonlat = map.getLonLatFromViewPortPx(event.xy);
                //     //var lonlat = map.getLonLatFromPixel([event.pageX, event.pageY]);
                //     //console.log(lonlat);
                //     //var lonlatTransf = lonlat.transform(map.getProjectionObject(), 'EPSG:3857');
                //     //console.log(lonlatTransf);
                //     // mouseLat = lonlatTransf.lat;
                //     // mouseLon = lonlatTransf.lon;
                    
                //                     console.log("position");
                //                     console.log(position);
                //                     console.log(ol.proj.fromLonLat([event.pageX, event.pageY]));
                //                     console.log(ol.proj.transform([event.pageX, event.pageY], 'EPSG:4326', 'EPSG:3857'));
    
            });

            elem.mousemove(function( event ) {
                // console.log("move");
            });

            elem.mouseup(function( event ) {
            //     console.log("mouseup");
            //     if(!clickOffset) {
            //         return;    
            //     }
            //     var newPosition = [event.pageX - clickOffset[0], event.pageY - clickOffset[1]];
            //     var position = map.getCoordinateFromPixel(newPosition);
            //     console.log([event.pageX, event.pageY], clickOffset, newPosition);
            //     overlay.setPosition(position);
            //     clickOffset = null;
            });

            elem.mouseleave(function( event ) {
                //console.log("leave");
                //clickOffset = null;
            });

            elem.mouseout(function( event ) {
                //console.log("out");
                //clickOffset = null;
            });

            elem.click(function(evt) {
                // console.log(evt);
            });

            var overlay =  new ol.Overlay({
                //stopEvent: false,
                element: elem[0],
                position: position,
                positioning: 'top-left'
            });
            
            return overlay;
        }
            
        var layer = new ol.layer.Tile({
            source: new ol.source.MapQuest({
                layer: 'osm'
            })
        });
        var map = new ol.Map({
            target: 'map',
            renderer: 'canvas',
            layers: [layer],
            view: new ol.View({
                center: [0, 0],
                zoom: 2
            })
        });

        map.on('singleclick', function (e) {
            console.log("singleclick2");
            console.log(e);
            var feature = map.forEachFeatureAtPixel(e.pixel,
                function(feature, layer) {
                    console.log(feature);
                    console.log(layer);
                    // do stuff here
                });                    
        });

        // map.on('movestart', function (e) {
        //     console.log("movestart");
        // });

        // map.on('mousemove', function (e) {
        //     console.log("mousemove");
        // });

        // map.on('pointermove', function (e) {
        //     console.log("mousemove");
        // });

        var clickOffset;
        
        document.addEventListener("drag", function( event ) {
            console.log("drag");
        }, false);

        document.addEventListener("dragstart", function( event ) {
            //event.target.style.opacity = .5;
            console.log("dragstart");
            clickOffset = [event.pageX - event.target.offsetParent.offsetLeft, event.pageY - event.target.offsetParent.offsetTop];
            //console.log(event.pageX, event.pageY, event.target.offsetParent.offsetLeft, event.target.offsetParent.offsetTop, event.pageX - event.target.offsetParent.offsetLeft, event.pageY - event.target.offsetParent.offsetTop );
        }, false);

        document.addEventListener("dragend", function( event ) {
            //event.target.style.opacity = "";
            console.log("dragend");
            var overlay = getOverlayForElement(event.target);
            if(overlay) {
                var newPosition = [event.pageX - clickOffset[0], event.pageY - clickOffset[1]];
                console.log([event.pageX, event.pageY], clickOffset, newPosition);
                var position = map.getCoordinateFromPixel(newPosition);
                overlay.setPosition(position);                    
            }
        }, false);

       function getOverlayForElement(element) {
            var overlay; 
            map.getOverlays().forEach(function(o) { 
                if(o.getElement() == element) {
                    overlay = o;
                }
            });
            return overlay;
        }

        //var selectInteraction = getSelectInteraction(layer);
        //var features = selectInteraction.getFeatures();
        // map.addInteraction(selectInteraction);
        // map.addInteraction(getModifyInteraction(features));
        // map.addInteraction(getTranslateInteraction(features));
        
		// function getSelectInteraction(layer) {
		// 	var interaction = new ol.interaction.Select({
		// 		layers: [layer]
		// 	});
		// 	return interaction;
		// }

		// function getModifyInteraction(features) {
		// 	return new ol.interaction.Modify({
		// 		features: features
		// 	});
		// }

		// function getTranslateInteraction(features) {
		// 	return new ol.interaction.Translate({
		// 		features: features
		// 	});
		// }

        $.get('./2012_Earthquakes_Mag5.kml')
            .done(function(response){
                var format = new ol.format.KML();
                var features = format.readFeatures(response, {
                    featureProjection: 'EPSG:3857'
                });
                var coordinates, overlay;
                for (var i = 0; i < features.length; i+=200) {
                    var text = features[i].get("name");
                    coordinates = features[i].getGeometry().getCoordinates();
                    overlay = createImageOverlay(coordinates, text);
                    map.addOverlay(overlay);
                    $(overlay.element).resizable().draggable();
                };
            });
    </script>

</body>

</html>